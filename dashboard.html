<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumBot | Investment Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .gradient-text {
            background: linear-gradient(90deg, #6E44FF 0%, #FF44B4 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(110, 68, 255, 0.3);
        }
        .dashboard-card {
            background: linear-gradient(135deg, rgba(110, 68, 255, 0.1) 0%, rgba(255, 68, 180, 0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #mobile-menu {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        #mobile-menu:not(.hidden) {
            max-height: 500px;
        }
        .investment-progress {
            height: 6px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .investment-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">
    <!-- Navigation Bar -->
    <nav class="bg-gray-800 border-b border-gray-700 py-3 px-6 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-purple-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-xl"></i>
                </div>
                <span class="text-xl font-bold">Quantum<span class="gradient-text">Bot</span></span>
            </a>
        </div>
        
        <div class="hidden md:flex items-center space-x-6">
            <a href="dashboard.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </a>
            <a href="index.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-chart-line mr-2"></i> Trading
            </a>
            <a href="deposit.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-money-bill-wave mr-2"></i> Deposit
            </a>
            <div class="flex items-center space-x-2 bg-gray-700 px-4 py-2 rounded-lg">
                <i class="fas fa-wallet text-purple-400"></i>
                <span id="wallet-balance">$0.00</span>
            </div>
            <div class="flex items-center space-x-2">
                <i class="fas fa-user-circle text-xl text-purple-400"></i>
                <span id="username-display">Guest</span>
            </div>
            <a href="logout.html" class="px-3 py-2 text-gray-300 hover:text-red-400 flex items-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </a>
        </div>
        
        <button id="mobile-menu-button" class="md:hidden text-2xl focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="md:hidden hidden bg-gray-800 border-b border-gray-700 px-6 py-3">
        <div class="flex flex-col space-y-4">
            <a href="dashboard.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
            </a>
            <a href="index.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-chart-line mr-2"></i> Trading
            </a>
            <a href="deposit.html" class="px-3 py-2 text-gray-300 hover:text-purple-400 flex items-center">
                <i class="fas fa-money-bill-wave mr-2"></i> Deposit
            </a>
            <div class="flex items-center space-x-2 bg-gray-700 px-4 py-2 rounded-lg">
                <i class="fas fa-wallet text-purple-400"></i>
                <span id="mobile-wallet-balance">$0.00</span>
            </div>
            <div class="flex items-center space-x-2">
                <i class="fas fa-user-circle text-xl text-purple-400"></i>
                <span id="mobile-username-display">Guest</span>
            </div>
            <a href="logout.html" class="px-3 py-2 text-gray-300 hover:text-red-400 flex items-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </a>
        </div>
    </div>

<!-- QuantumBot User Search Link - Add this anywhere in your page -->
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <a href="./others.html" 
     style="display: inline-flex; align-items: center; 
            background: linear-gradient(90deg, #6E44FF 0%, #FF44B4 100%);
            color: white; padding: 10px 15px; border-radius: 9999px;
            text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;"
     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 8px rgba(0,0,0,0.15)'"
     onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'">
    <i class="fas fa-search" style="margin-right: 8px;"></i>
    Search Other Trader's Performance
  </a>
</div>

    <!-- Dashboard Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Dashboard Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2">
                    <i class="fas fa-chart-pie text-purple-400 mr-3"></i>
                    Investment Portfolio
                </h1>
                <p class="text-gray-400">Track your total investments, profits, and net worth over time</p>
            </div>
            <div class="mt-4 md:mt-0 flex space-x-3">
                <select id="time-filter" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="all">All Time</option>
                </select>
                <button id="refresh-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Investment Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Net Worth -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400">Net Worth</p>
                        <h3 id="net-worth-kpi" class="text-3xl font-bold mt-1">$0.00</h3>
                    </div>
                    <div class="bg-purple-600 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-piggy-bank text-purple-400 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm flex items-center">
                        <span id="net-worth-change" class="font-medium mr-2">0%</span>
                        <span id="net-worth-change-text" class="text-gray-400">vs previous period</span>
                    </p>
                </div>
            </div>
            
            <!-- Total Invested -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400">Total Invested</p>
                        <h3 id="total-invested-kpi" class="text-3xl font-bold mt-1">$0.00</h3>
                    </div>
                    <div class="bg-blue-600 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-hand-holding-usd text-blue-400 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm text-gray-400">
                        <span id="last-deposit">Last deposit: $0.00</span>
                    </p>
                </div>
            </div>
            
            <!-- Total Profit -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400">Total Profit</p>
                        <h3 id="total-profit-kpi" class="text-3xl font-bold mt-1">$0.00</h3>
                    </div>
                    <div class="bg-green-600 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-coins text-green-400 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-sm flex items-center">
                        <span id="profit-change" class="font-medium mr-2">0%</span>
                        <span id="profit-change-text" class="text-gray-400">ROI</span>
                    </p>
                </div>
            </div>
            
            <!-- ROI Percentage -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400">Return on Investment</p>
                        <h3 id="roi-kpi" class="text-3xl font-bold mt-1">0%</h3>
                    </div>
                    <div class="bg-orange-600 bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-percentage text-orange-400 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="investment-progress w-full">
                        <div id="roi-progress-bar" class="investment-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Investment Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Investment Growth -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-chart-line text-purple-400 mr-3"></i>
                    Investment Growth
                </h2>
                <div id="investment-growth-chart" class="h-80"></div>
            </div>
            
            <!-- Asset Allocation -->
            <div class="dashboard-card rounded-xl p-6 card-hover">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-pie-chart text-purple-400 mr-3"></i>
                    Asset Allocation
                </h2>
                <div id="asset-allocation-chart" class="h-80"></div>
            </div>
        </div>

        <!-- Investment Performance Section -->
        <div class="dashboard-card rounded-xl p-6 mb-8 card-hover">
            <h2 class="text-xl font-bold mb-6 flex items-center">
                <i class="fas fa-trophy text-purple-400 mr-3"></i>
                Investment Performance
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Monthly Performance -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">Monthly Performance</h3>
                    <div id="monthly-performance-chart" class="h-64"></div>
                </div>
                
                <!-- Profit Sources -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">Profit Sources</h3>
                    <div id="profit-sources-chart" class="h-64"></div>
                </div>
                
                <!-- Investment Timeline -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">Investment Timeline</h3>
                    <div id="investment-timeline-chart" class="h-64"></div>
                </div>
            </div>
        </div>

        <!-- Recent Investment Activity -->
        <div class="dashboard-card rounded-xl overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-list text-purple-400 mr-3"></i>
                    Recent Investment Activity
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-investments" class="divide-y divide-gray-700">
                            <!-- Investments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                
                // Toggle between hamburger and close icon
                const icon = mobileMenuButton.querySelector('i');
                if (mobileMenu.classList.contains('hidden')) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                } else {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                }
            });

            // Add logout functionality
            const logoutLinks = document.querySelectorAll('a[href="logout.html"]');
            logoutLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Clear user session
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('userEmail');
                    // Redirect to login page
                    window.location.href = 'login.html';
                });
            });
        });

        // Load user data from localStorage
        function loadUserData() {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                window.location.href = 'login.html';
                return null;
            }
            
            try {
                return JSON.parse(currentUserStr);
            } catch (e) {
                console.error("Error parsing user data:", e);
                window.location.href = 'login.html';
                return null;
            }
        }

        // Process investment data from user's trading history and transactions
        function processInvestmentData(userData) {
            if (!userData) return {};
            
            // Calculate total invested from deposits
            const deposits = userData.transactions?.filter(t => t.type === 'deposit') || [];
            const totalInvested = deposits.reduce((sum, deposit) => sum + deposit.amount, 0);
            
            // Get total profit from user data
            const totalProfit = userData.totalProfit || 0;
            
            // Calculate net worth
            const netWorth = totalInvested + totalProfit;
            
            // Group transactions by month for monthly performance
            const monthlyPerformance = {};
            const allTransactions = [...(userData.transactions || []), ...(userData.tradingHistory || [])];
            
            allTransactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyPerformance[monthYear]) {
                    monthlyPerformance[monthYear] = {
                        invested: 0,
                        profit: 0,
                        netWorth: 0
                    };
                }
                
                if (transaction.type === 'deposit') {
                    monthlyPerformance[monthYear].invested += transaction.amount;
                } else if (transaction.profit !== undefined) {
                    monthlyPerformance[monthYear].profit += transaction.profit;
                }
            });
            
            // Calculate cumulative values for each month
            let runningInvested = 0;
            let runningProfit = 0;
            
            Object.keys(monthlyPerformance).sort().forEach(month => {
                runningInvested += monthlyPerformance[month].invested;
                runningProfit += monthlyPerformance[month].profit;
                monthlyPerformance[month].netWorth = runningInvested + runningProfit;
                monthlyPerformance[month].invested = runningInvested;
                monthlyPerformance[month].profit = runningProfit;
            });
            
            // Create timeline data
            const timelineData = [];
            let runningBalance = 0;
            
            // Process deposits first
            deposits.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(deposit => {
                runningBalance += deposit.amount;
                timelineData.push({
                    x: new Date(deposit.date).getTime(),
                    y: runningBalance,
                    type: 'deposit',
                    amount: deposit.amount
                });
            });
            
            // Then process trading profits
            const trades = userData.tradingHistory?.sort((a, b) => new Date(a.date) - new Date(b.date)) || [];
            trades.forEach(trade => {
                if (trade.profit) {
                    runningBalance += trade.profit;
                    timelineData.push({
                        x: new Date(trade.date).getTime(),
                        y: runningBalance,
                        type: 'profit',
                        amount: trade.profit
                    });
                }
            });
            
            return {
                totalInvested,
                totalProfit,
                netWorth,
                monthlyPerformance,
                timelineData,
                transactions: allTransactions,
                lastDeposit: deposits.length > 0 ? deposits[deposits.length - 1] : null
            };
        }

        // Load investment data with time filter
        function loadInvestmentData(days = 30) {
            const currentUser = loadUserData();
            if (!currentUser) return {};
            
            const investmentData = processInvestmentData(currentUser);
            
            const now = new Date();
            let cutoffDate = new Date();

            if (days === 'all') {
                cutoffDate = new Date(0); // All time
            } else {
                cutoffDate.setDate(now.getDate() - parseInt(days));
            }

            // Filter investments by date
            const recentInvestments = investmentData.transactions?.filter(transaction => {
                return new Date(transaction.date) >= cutoffDate;
            }) || [];

            // Filter previous period for comparison (only if not "all time")
            let previousPeriodInvestments = [];
            if (days !== 'all') {
                const prevCutoffDate = new Date();
                prevCutoffDate.setDate(now.getDate() - (parseInt(days) * 2));
                previousPeriodInvestments = investmentData.transactions?.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    return transactionDate >= prevCutoffDate && transactionDate < cutoffDate;
                }) || [];
            }

            return {
                recentInvestments,
                previousPeriodInvestments,
                allInvestments: investmentData.transactions || [],
                totalInvested: investmentData.totalInvested || 0,
                totalProfit: investmentData.totalProfit || 0,
                netWorth: investmentData.netWorth || 0,
                monthlyPerformance: investmentData.monthlyPerformance || {},
                timelineData: investmentData.timelineData || [],
                lastDeposit: investmentData.lastDeposit,
                balance: currentUser.balance || 0
            };
        }

        // Calculate investment KPIs
        function calculateKPIs(investments, prevInvestments = [], investmentData) {
            if (!investmentData) {
                return {
                    totalInvested: 0,
                    totalProfit: 0,
                    netWorth: 0,
                    roi: 0,
                    netWorthChange: 0,
                    profitChange: 0,
                    lastDeposit: { amount: 0, date: '' },
                    monthlyPerformance: {},
                    timelineData: []
                };
            }

            // Calculate previous period values for comparison
            let prevNetWorth = 0;
            let prevProfit = 0;
            if (prevInvestments.length > 0) {
                const prevData = processInvestmentData({
                    transactions: prevInvestments,
                    tradingHistory: prevInvestments.filter(t => t.profit !== undefined)
                });
                prevNetWorth = prevData.netWorth;
                prevProfit = prevData.totalProfit;
            }

            const currentNetWorth = investmentData.netWorth || 0;
            const currentProfit = investmentData.totalProfit || 0;
            
            const netWorthChange = prevNetWorth !== 0 ? 
                ((currentNetWorth - prevNetWorth) / prevNetWorth) * 100 : 0;
            
            const profitChange = prevProfit !== 0 ? 
                ((currentProfit - prevProfit) / Math.abs(prevProfit)) * 100 : 0;

            const roi = investmentData.totalInvested > 0 ? 
                (investmentData.totalProfit / investmentData.totalInvested) * 100 : 0;

            return {
                totalInvested: investmentData.totalInvested || 0,
                totalProfit: investmentData.totalProfit || 0,
                netWorth: investmentData.netWorth || 0,
                roi,
                netWorthChange,
                profitChange,
                lastDeposit: investmentData.lastDeposit || { amount: 0, date: '' },
                monthlyPerformance: investmentData.monthlyPerformance || {},
                timelineData: investmentData.timelineData || []
            };
        }

        // Update KPI cards
        function updateKPIs(kpis, currentUser) {
            // Net Worth
            document.getElementById('net-worth-kpi').textContent = `$${kpis.netWorth.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const netWorthChangeElement = document.getElementById('net-worth-change');
            netWorthChangeElement.textContent = `${kpis.netWorthChange > 0 ? '+' : ''}${kpis.netWorthChange.toFixed(1)}%`;
            netWorthChangeElement.className = kpis.netWorthChange > 0 ? 'font-medium mr-2 text-green-500' : 'font-medium mr-2 text-red-500';
            
            // Total Invested
            document.getElementById('total-invested-kpi').textContent = `$${kpis.totalInvested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('last-deposit').textContent = `Last deposit: $${kpis.lastDeposit?.amount?.toFixed(2) || '0.00'}`;
            
            // Total Profit
            document.getElementById('total-profit-kpi').textContent = `$${kpis.totalProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const profitChangeElement = document.getElementById('profit-change');
            profitChangeElement.textContent = `${kpis.roi > 0 ? '+' : ''}${kpis.roi.toFixed(1)}%`;
            profitChangeElement.className = kpis.roi >= 0 ? 'font-medium mr-2 text-green-500' : 'font-medium mr-2 text-red-500';
            
            // ROI
            document.getElementById('roi-kpi').textContent = `${kpis.roi.toFixed(1)}%`;
            const roiProgressBar = document.getElementById('roi-progress-bar');
            roiProgressBar.style.width = `${Math.min(Math.abs(kpis.roi), 100)}%`;
            roiProgressBar.className = kpis.roi >= 0 ? 
                'investment-progress-bar bg-green-500' : 'investment-progress-bar bg-red-500';
            
            // Wallet balance
            const balance = currentUser?.balance || 0;
            document.getElementById('wallet-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('mobile-wallet-balance').textContent = `$${balance.toFixed(2)}`;
            
            // Set username with role badge if admin
            if (currentUser) {
                document.getElementById('username-display').innerHTML = currentUser.username + 
                    (currentUser.role === 'admin' ? ' <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">ADMIN</span>' : '');
                document.getElementById('mobile-username-display').innerHTML = currentUser.username + 
                    (currentUser.role === 'admin' ? ' <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded-full">ADMIN</span>' : '');
            }
        }

        // Render investment charts
        function renderCharts(kpis, investmentData) {
            // Destroy existing charts if they exist
            if (window.investmentGrowthChart) window.investmentGrowthChart.destroy();
            if (window.assetAllocationChart) window.assetAllocationChart.destroy();
            if (window.monthlyPerformanceChart) window.monthlyPerformanceChart.destroy();
            if (window.profitSourcesChart) window.profitSourcesChart.destroy();
            if (window.investmentTimelineChart) window.investmentTimelineChart.destroy();

            // Investment Growth Chart (Line)
            const monthlyData = Object.entries(kpis.monthlyPerformance).sort((a, b) => a[0].localeCompare(b[0]));
            
            window.investmentGrowthChart = new ApexCharts(document.getElementById('investment-growth-chart'), {
                series: [
                    {
                        name: 'Total Invested',
                        data: monthlyData.map(([month, data]) => ({
                            x: month,
                            y: data.invested
                        }))
                    },
                    {
                        name: 'Net Worth',
                        data: monthlyData.map(([month, data]) => ({
                            x: month,
                            y: data.netWorth
                        }))
                    }
                ],
                chart: {
                    type: 'line',
                    height: '100%',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    },
                    zoom: {
                        enabled: true
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                colors: ['#6E44FF', '#10B981'],
                xaxis: {
                    type: 'category'
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            });
            window.investmentGrowthChart.render();

            // Asset Allocation Chart (Donut)
            // For simplicity, we'll assume 100% is in trading for this demo
            // In a real app, you'd get this data from your backend
            window.assetAllocationChart = new ApexCharts(document.getElementById('asset-allocation-chart'), {
                series: [100], // All allocated to trading
                chart: {
                    type: 'donut',
                    height: '100%'
                },
                labels: ['Trading'],
                colors: ['#6E44FF'],
                plotOptions: {
                    pie: {
                        donut: {
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total Allocation',
                                    formatter: function() {
                                        return '100%';
                                    }
                                }
                            }
                        }
                    }
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            });
            window.assetAllocationChart.render();

            // Monthly Performance Chart (Bar)
            window.monthlyPerformanceChart = new ApexCharts(document.getElementById('monthly-performance-chart'), {
                series: [{
                    name: 'Monthly Profit',
                    data: monthlyData.map(([month, data]) => ({
                        x: month,
                        y: data.profit
                    }))
                }],
                chart: {
                    type: 'bar',
                    height: '100%',
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: false,
                        columnWidth: '70%',
                    }
                },
                dataLabels: {
                    enabled: false
                },
                colors: ['#6E44FF'],
                xaxis: {
                    type: 'category'
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                }
            });
            window.monthlyPerformanceChart.render();

            // Profit Sources Chart (Radial)
            // For simplicity, we'll assume all profit is from trading
            // In a real app, you'd get this data from your backend
            window.profitSourcesChart = new ApexCharts(document.getElementById('profit-sources-chart'), {
                series: [100], // All profit from trading
                chart: {
                    type: 'radialBar',
                    height: '100%'
                },
                plotOptions: {
                    radialBar: {
                        offsetY: 0,
                        startAngle: 0,
                        endAngle: 270,
                        hollow: {
                            margin: 5,
                            size: '30%',
                            background: 'transparent',
                            image: undefined,
                        },
                        dataLabels: {
                            name: {
                                show: false,
                            },
                            value: {
                                show: false,
                            }
                        },
                        track: {
                            show: true,
                            startAngle: undefined,
                            endAngle: undefined,
                            background: '#2D3748',
                            strokeWidth: '97%',
                            opacity: 1,
                            margin: 5,
                        }
                    }
                },
                colors: ['#6E44FF'],
                labels: ['Trading'],
                legend: {
                    show: true,
                    floating: true,
                    fontSize: '14px',
                    position: 'left',
                    offsetX: 0,
                    offsetY: 0,
                    labels: {
                        useSeriesColors: true,
                    },
                    markers: {
                        size: 0
                    },
                    formatter: function(seriesName, opts) {
                        return seriesName + ":  " + opts.w.globals.series[opts.seriesIndex] + '%';
                    },
                    itemMargin: {
                        vertical: 3
                    }
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        legend: {
                            show: false
                        }
                    }
                }]
            });
            window.profitSourcesChart.render();

            // Investment Timeline Chart (Line)
            window.investmentTimelineChart = new ApexCharts(document.getElementById('investment-timeline-chart'), {
                series: [{
                    name: 'Portfolio Value',
                    data: kpis.timelineData
                }],
                chart: {
                    type: 'line',
                    height: '100%',
                    toolbar: {
                        show: false
                    }
                },
                stroke: {
                    curve: 'stepline',
                    width: 2
                },
                colors: ['#6E44FF'],
                markers: {
                    size: 5,
                    colors: kpis.timelineData.map(point => 
                        point.type === 'deposit' ? '#10B981' : '#3B82F6'),
                    strokeColors: '#1F2937',
                    strokeWidth: 2
                },
                xaxis: {
                    type: 'datetime'
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                },
                tooltip: {
                    custom: function({ series, seriesIndex, dataPointIndex, w }) {
                        const point = kpis.timelineData[dataPointIndex];
                        return `
                            <div class="bg-gray-800 p-3 rounded-lg shadow-lg border border-gray-700">
                                <div class="text-sm font-bold mb-1">
                                    ${point.type === 'deposit' ? 'Deposit' : 'Profit'} on ${new Date(point.x).toLocaleDateString()}
                                </div>
                                <div class="text-sm">
                                    Amount: $${point.amount.toFixed(2)}
                                </div>
                                <div class="text-sm">
                                    New Balance: $${point.y.toFixed(2)}
                                </div>
                            </div>
                        `;
                    }
                }
            });
            window.investmentTimelineChart.render();
        }

        // Load recent investments table
        function loadRecentInvestments(investments) {
            const table = document.getElementById('recent-investments');
            table.innerHTML = '';

            if (!investments || investments.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-400">No investment activity found</td>
                    </tr>
                `;
                return;
            }

            // Show only last 10 investments, sorted by date (newest first)
            const recent = investments
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            recent.forEach(investment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${new Date(investment.date).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            investment.type === 'deposit' 
                                ? 'bg-blue-900 text-blue-300' 
                                : investment.profit !== undefined 
                                    ? (investment.profit >= 0 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300')
                                    : 'bg-gray-700 text-gray-300'
                        }">
                            ${investment.type.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap ${
                        investment.type === 'deposit' 
                            ? 'text-blue-400' 
                            : investment.profit !== undefined 
                                ? (investment.profit >= 0 ? 'text-green-400' : 'text-red-400')
                                : 'text-gray-400'
                    }">
                        ${investment.type === 'deposit' ? '+' : ''}$${
                            (investment.amount || investment.profit || 0).toFixed(2)
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        $${(investment.balance || 0).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            investment.status === 'completed' 
                                ? 'bg-green-900 text-green-300' 
                                : 'bg-yellow-900 text-yellow-300'
                        }">
                            ${(investment.status || 'completed').toUpperCase()}
                        </span>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // Refresh dashboard
        function refreshDashboard(days = 30) {
            const currentUser = loadUserData();
            if (!currentUser) return;
            
            const { recentInvestments, previousPeriodInvestments, ...investmentData } = loadInvestmentData(days);
            const kpis = calculateKPIs(recentInvestments, previousPeriodInvestments, investmentData);
            
            updateKPIs(kpis, currentUser);
            renderCharts(kpis, investmentData);
            loadRecentInvestments(recentInvestments);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial time filter
            const timeFilter = document.getElementById('time-filter');
            timeFilter.addEventListener('change', (e) => {
                refreshDashboard(e.target.value);
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', () => {
                refreshDashboard(timeFilter.value);
            });

            // Initial load
            refreshDashboard(timeFilter.value);
        });
    </script>
</body>
</html>
